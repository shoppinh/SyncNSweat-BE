name: "Build and Deploy to Cloud Run"

# ========================================
# CI/CD Workflow for Deploy Module Only
# ========================================
# This workflow ONLY deploys application infrastructure.
# Bootstrap (IAM, APIs, service accounts) must be run manually by an admin.
#
# Security model:
# - Uses Workload Identity Federation (no service account keys)
# - Runs with limited permissions (roles defined in bootstrap)
# - Cannot modify project IAM or enable APIs
# ========================================

concurrency:
  group: deploy-cloudrun-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # Application secrets - deployed to Secret Manager, not used by Terraform
  SECRET_KEY: "${{ secrets.SECRET_KEY }}"
  SPOTIFY_CLIENT_ID: "${{ secrets.SPOTIFY_CLIENT_ID }}"
  SPOTIFY_CLIENT_SECRET: "${{ secrets.SPOTIFY_CLIENT_SECRET }}"
  EXERCISE_API_KEY: "${{ secrets.EXERCISE_API_KEY }}"
  EXERCISE_API_HOST: "${{ secrets.EXERCISE_API_HOST }}"
  GEMINI_API_KEY: "${{ secrets.GEMINI_API_KEY }}"
  DEFAULT_SPOTIFY_USER_PASSWORD: "${{ secrets.DEFAULT_SPOTIFY_USER_PASSWORD }}"

jobs:
  deploy:
    runs-on: "ubuntu-latest"
    timeout-minutes: 30

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332" # actions/checkout@v4

      - name: "Authenticate to Google Cloud (Workload Identity)"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: "${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}"
          service_account: "${{ secrets.GCP_SERVICE_ACCOUNT }}"

      # Install gcloud CLI (auth action doesn't always include all gcloud commands)
      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      # ========================================
      # Validate Bootstrap Completion
      # ========================================
      - name: "Validate Bootstrap Completion"
        working-directory: infra/deploy
        run: |
          echo "üîç Validating that bootstrap module has been completed..."
          
          # Run validation
          ./validate.sh "${{ secrets.GCP_PROJECT_ID }}"

      # ========================================
      # Deploy Application Infrastructure
      # ========================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false  # Needed to parse outputs as JSON
        
      - name: Terraform Init (Deploy Module)
        working-directory: infra/deploy
        run: terraform init

      - name: Terraform Plan (Deploy Module)
        working-directory: infra/deploy
        run: |
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ secrets.GCP_REGION }}" \
            -var="db_password=${{ secrets.GCP_CLOUD_SQL_DB_PASSWORD }}" \
            -out=tfplan
        
      - name: Terraform Apply (Deploy Module Only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' 
        working-directory: infra/deploy
        run: |
          terraform apply -auto-approve tfplan 

      # ========================================
      # Get Terraform Outputs
      # ========================================
      - name: "Get Terraform Outputs"
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: tf
        working-directory: infra/deploy
        run: |
          echo "project_id=$(terraform output -raw project_id)" >> $GITHUB_OUTPUT
          echo "region=$(terraform output -raw region)" >> $GITHUB_OUTPUT
          echo "service_name=$(terraform output -raw cloud_run_service_name)" >> $GITHUB_OUTPUT
          echo "artifact_registry_url=$(terraform output -raw artifact_registry_url)" >> $GITHUB_OUTPUT
          echo "github_actions_sa=$(terraform output -raw github_actions_service_account)" >> $GITHUB_OUTPUT
          echo "cloudrun_service_account=$(terraform output -raw cloud_run_service_account)" >> $GITHUB_OUTPUT
          echo "cloud_run_url=$(terraform output -raw cloud_run_url)" >> $GITHUB_OUTPUT
          echo "cloud_sql_connection=$(terraform output -raw cloud_sql_connection_name)" >> $GITHUB_OUTPUT
          echo "secret_names=$(terraform output -json secret_names)" >> $GITHUB_OUTPUT
          echo "database_user=$(terraform output -raw database_user)" >> $GITHUB_OUTPUT
          echo "database_name=$(terraform output -raw database_name)" >> $GITHUB_OUTPUT

      # ========================================
      # Update Secret Values in Secret Manager
      # ========================================
      # Terraform creates empty secret containers; this step populates values
      - name: "Update Secret Values in GCP Secret Manager"
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Get secret names from Terraform outputs
          SECRET_NAMES='${{ steps.tf.outputs.secret_names }}'
          
          # Function to update a secret value (Terraform created the secret resource)
          update_secret_value() {
            SECRET_NAME=$1
            SECRET_VALUE=$2
            
            if [ -z "$SECRET_VALUE" ]; then
              echo "‚ö†Ô∏è  Warning: No value provided for ${SECRET_NAME} - skipping"
              return
            fi
            
            echo "‚úì Updating secret value: ${SECRET_NAME}"
            echo -n "${SECRET_VALUE}" | gcloud secrets versions add "${SECRET_NAME}" \
              --project="${{ steps.tf.outputs.project_id }}" \
              --data-file=-
          }
          
          # Construct socket-style DATABASE_URI for Cloud Run's built-in Cloud SQL connector
          DB_USER="${{steps.tf.outputs.database_user}}"
          DB_NAME="${{steps.tf.outputs.database_name}}"
          DB_PASS="${{ secrets.GCP_CLOUD_SQL_DB_PASSWORD }}"
          CLOUD_SQL_INSTANCE="${{ steps.tf.outputs.cloud_sql_connection }}"
          DATABASE_URI_SOCKET="postgresql://${DB_USER}:${DB_PASS}@/${DB_NAME}?host=/cloudsql/${CLOUD_SQL_INSTANCE}"

          # Update all secret values
          update_secret_value "DATABASE_URI" "${DATABASE_URI_SOCKET}"
          update_secret_value "SECRET_KEY" "${{ env.SECRET_KEY }}"
          update_secret_value "SPOTIFY_CLIENT_ID" "${{ env.SPOTIFY_CLIENT_ID }}"
          update_secret_value "SPOTIFY_CLIENT_SECRET" "${{ env.SPOTIFY_CLIENT_SECRET }}"
          update_secret_value "SPOTIFY_REDIRECT_URL" "${{ steps.tf.outputs.cloud_run_url }}"
          update_secret_value "EXERCISE_API_KEY" "${{ env.EXERCISE_API_KEY }}"
          update_secret_value "EXERCISE_API_HOST" "${{ env.EXERCISE_API_HOST }}"
          update_secret_value "API_URL" "${{ steps.tf.outputs.cloud_run_url }}"
          update_secret_value "GEMINI_API_KEY" "${{ env.GEMINI_API_KEY }}"
          update_secret_value "DEFAULT_SPOTIFY_USER_PASSWORD" "${{ env.DEFAULT_SPOTIFY_USER_PASSWORD }}"
          
          echo ""
          echo "‚úÖ All secrets updated successfully"

      # ========================================
      # Build and Push Container Image
      # ========================================
      - name: "Build and Push Container with Cloud Build"
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |-
          IMAGE="${{ steps.tf.outputs.artifact_registry_url }}/${{ steps.tf.outputs.service_name }}:${{ github.sha }}"
          
          echo "Building and pushing image: ${IMAGE}"
          gcloud builds submit \
            --project="${{ steps.tf.outputs.project_id }}" \
            --tag "${IMAGE}" \
            --service-account="${{ steps.tf.outputs.github_actions_sa }}" \
            --gcs-log-dir=gs://${{ secrets.GCP_BUCKET_NAME }} \
            .

      # ========================================
      # Deploy to Cloud Run
      # ========================================

      - name: "Deploy to Cloud Run"
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "${{ steps.tf.outputs.service_name }}"
          region: "${{ steps.tf.outputs.region }}"
          image: "${{ steps.tf.outputs.artifact_registry_url }}/${{ steps.tf.outputs.service_name }}:${{ github.sha }}"
          flags: |
            --port=8000
            --add-cloudsql-instances=${{ steps.tf.outputs.cloud_sql_connection }}
            --service-account="${{ steps.tf.outputs.cloudrun_service_account }}"
            --concurrency=50
            --memory=512Mi
          # Use full Secret Manager resource names for clarity and tighter access control
          secrets: |
            DATABASE_URI=DATABASE_URI:latest
            SECRET_KEY=SECRET_KEY:latest
            SPOTIFY_CLIENT_ID=SPOTIFY_CLIENT_ID:latest
            SPOTIFY_CLIENT_SECRET=SPOTIFY_CLIENT_SECRET:latest
            SPOTIFY_REDIRECT_URL=SPOTIFY_REDIRECT_URL:latest
            EXERCISE_API_KEY=EXERCISE_API_KEY:latest
            EXERCISE_API_HOST=EXERCISE_API_HOST:latest
            API_URL=API_URL:latest
            GEMINI_API_KEY=GEMINI_API_KEY:latest
            DEFAULT_SPOTIFY_USER_PASSWORD=DEFAULT_SPOTIFY_USER_PASSWORD:latest