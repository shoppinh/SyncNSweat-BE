name: "Build and Deploy to Cloud Run"
concurrency:
  group: deploy-cloudrun-${{ github.ref }}
  cancel-in-progress: true
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PROJECT_ID: "${{ secrets.GCP_PROJECT_ID }}" # TODO: update to your Google Cloud project ID
  REGION: "${{ secrets.GCP_REGION }}" # TODO: update to your region
  SERVICE_NAME: "${{ secrets.GCP_SERVICE_NAME }}" # TODO: update to your service name
  SERVICE_REGISTRY: "${{ secrets.GCP_SERVICE_REGISTRY }}"
  CLOUD_SQL_INSTANCE_ID: "${{ secrets.GCP_CLOUD_SQL_INSTANCE_ID }}"
  CLOUD_SQL_DB_PASSWORD: "${{ secrets.GCP_CLOUD_SQL_DB_PASSWORD }}"
  SERVICE_ACCOUNT: "${{ secrets.GCP_SERVICE_ACCOUNT }}"
  WORKLOAD_IDENTITY_PROVIDER: "${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}"

jobs:
  deploy:
    runs-on: "ubuntu-latest"
    timeout-minutes: 30

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332" # actions/checkout@v4

      # Configure Workload Identity Federation and generate an access token.
      # See https://github.com/google-github-actions/auth for options.
      - id: "auth"
        name: "Authenticate to Google Cloud (Workload Identity)"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: "${{ env.WORKLOAD_IDENTITY_PROVIDER }}"
          service_account: "${{ env.SERVICE_ACCOUNT }}"

      # Update GCP Secret Manager directly (bypassing Terraform state)
      - name: "Update Secrets in GCP Secret Manager"
        run: |
          # Function to create or update a secret
          update_secret() {
            SECRET_NAME=$1
            SECRET_VALUE=$2
            
            # Check if secret exists
            if gcloud secrets describe "${SECRET_NAME}" --project="${{ env.PROJECT_ID }}" >/dev/null 2>&1; then
              echo "Updating existing secret: ${SECRET_NAME}"
              echo -n "${SECRET_VALUE}" | gcloud secrets versions add "${SECRET_NAME}" \
                --project="${{ env.PROJECT_ID }}" \
                --data-file=-
            else
              echo "Creating new secret: ${SECRET_NAME}"
              echo -n "${SECRET_VALUE}" | gcloud secrets create "${SECRET_NAME}" \
                --project="${{ env.PROJECT_ID }}" \
                --replication-policy="automatic" \
                --data-file=-
            fi
          }
          
          # Update all secrets
          update_secret "DATABASE_URI" "${{ secrets.DATABASE_URI }}"
          update_secret "SECRET_KEY" "${{ secrets.SECRET_KEY }}"
          update_secret "SPOTIFY_CLIENT_ID" "${{ secrets.SPOTIFY_CLIENT_ID }}"
          update_secret "SPOTIFY_CLIENT_SECRET" "${{ secrets.SPOTIFY_CLIENT_SECRET }}"
          update_secret "SPOTIFY_REDIRECT_URL" "${{ secrets.SPOTIFY_REDIRECT_URL }}"
          update_secret "EXERCISE_API_KEY" "${{ secrets.EXERCISE_API_KEY }}"
          update_secret "EXERCISE_API_HOST" "${{ secrets.EXERCISE_API_HOST }}"
          update_secret "API_URL" "${{ secrets.API_URL }}"
          update_secret "GEMINI_API_KEY" "${{ secrets.GEMINI_API_KEY }}"
          update_secret "DEFAULT_SPOTIFY_USER_PASSWORD" "${{ secrets.DEFAULT_SPOTIFY_USER_PASSWORD }}"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        
      - name: Terraform Init
        working-directory: infra
        run: terraform init
        
      - name: Terraform Plan
        working-directory: infra
        run: |
          terraform plan \
            -var="project_id=${{ env.PROJECT_ID }}" \
            -var="region=${{ env.REGION }}" \
            -var="github_repo=${{ github.repository }}" \
            -var="db_password=${{ env.CLOUD_SQL_DB_PASSWORD }}"
            
      - name: Terraform Apply
        working-directory: infra
        run: |
          terraform apply -auto-approve \
            -var="project_id=${{ env.PROJECT_ID }}" \
            -var="region=${{ env.REGION }}" \
            -var="github_repo=${{ github.repository }}" \
            -var="db_password=${{ env.CLOUD_SQL_DB_PASSWORD }}"

      # Build & push the image via Cloud Build (offloads build work to GCP and uses Artifact Registry)
      - name: "Build and Push Container with Cloud Build"
        env:
          GCP_SERVICE_ACCOUNT: "${{ env.SERVICE_ACCOUNT }}" # may be email or full resource name
        run: |-
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE_REGISTRY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          SA_RAW="${GCP_SERVICE_ACCOUNT}"
          # If no service account provided, submit without --service-account
          if [[ -z "${SA_RAW}" ]]; then
            echo "No GCP_SERVICE_ACCOUNT secret provided â€” submitting without explicit service account"
            gcloud builds submit --project="${{ env.PROJECT_ID }}" --tag "${IMAGE}" --gcs-log-dir=gs://sync-n-sweat-build-logs-bucket .
            exit $?
          fi

          # Normalize: if value looks like an email, convert to full resource name
          if [[ "${SA_RAW}" == *"@"* ]]; then
            SA="projects/${{ env.PROJECT_ID }}/serviceAccounts/${SA_RAW}"
          else
            SA="${SA_RAW}"
          fi

          # Basic validation
          if [[ "${SA}" != projects/*/serviceAccounts/* ]]; then
            echo "Invalid service account format in GCP_SERVICE_ACCOUNT secret"
            exit 1
          fi

          # Submit using the normalized service account
          gcloud builds submit --project="${{ env.PROJECT_ID }}" --tag "${IMAGE}" --service-account="${SA}" --gcs-log-dir=gs://sync-n-sweat-build-logs-bucket .

      - name: "Deploy to Cloud Run"
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: "${{ env.SERVICE_NAME }}"
          region: "${{ env.REGION }}"
          image: "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE_REGISTRY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          flags: |
            --port=8000
            --add-cloudsql-instances=${{ env.PROJECT_ID }}:${{ env.REGION }}:${{ env.CLOUD_SQL_INSTANCE_ID }}
            --service-account="${{ env.SERVICE_ACCOUNT }}"
            --concurrency=50
            --memory=512Mi
          # Use full Secret Manager resource names for clarity and tighter access control
          secrets: |
            DATABASE_URI=DATABASE_URI:latest
            SECRET_KEY=SECRET_KEY:latest
            SPOTIFY_CLIENT_ID=SPOTIFY_CLIENT_ID:latest
            SPOTIFY_CLIENT_SECRET=SPOTIFY_CLIENT_SECRET:latest
            SPOTIFY_REDIRECT_URL=SPOTIFY_REDIRECT_URL:latest
            EXERCISE_API_KEY=EXERCISE_API_KEY:latest
            EXERCISE_API_HOST=EXERCISE_API_HOST:latest
            API_URL=API_URL:latest
            GEMINI_API_KEY=GEMINI_API_KEY:latest
            DEFAULT_SPOTIFY_USER_PASSWORD=DEFAULT_SPOTIFY_USER_PASSWORD:latest